<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Murillo">

<title>Clase 8: Modelos jerárquicos de supervivencia</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Clase8_files/libs/clipboard/clipboard.min.js"></script>
<script src="Clase8_files/libs/quarto-html/quarto.js"></script>
<script src="Clase8_files/libs/quarto-html/popper.min.js"></script>
<script src="Clase8_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Clase8_files/libs/quarto-html/anchor.min.js"></script>
<link href="Clase8_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Clase8_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Clase8_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Clase8_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Clase8_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Clase 8: Modelos jerárquicos de supervivencia</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Murillo </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>El tema de esta clase es el célebre modelo Cormack-Jolly-Seber, o CJS (Cormack, 1964; Jolly, 1965; Seber, 1965), uno de los modelos estadísticos más famosos en ecología. El modelo CJS requiere datos de captura-recaptura en vivo (también llamados marcaje-recaptura o marcaje-reseñamiento) de individuos reconocibles individualmente. Esto generalmente significa individuos marcados (etiquetados), pero la identificación genética y, a veces, la variabilidad natural en el color o los patrones de plumas/pelaje/piel pueden servir igualmente bien para identificar de manera única a los individuos. El modelo CJS produce estimaciones de la probabilidad aparente de supervivencia <span class="math inline">\(\phi\)</span>, la probabilidad de que un individuo marcado permanezca vivo y en el área de estudio entre dos puntos temporales en los que se realizan los reconocimientos, y de la probabilidad de recaptura <em>p</em>, la probabilidad de que un individuo marcado se encuentre en un punto temporal determinado (nótese que la identificación en el tiempo amplio se refiere al re-avistamiento y cualquier otra forma de identificación individual). Sorprendentemente, el modelo CJS también estima la probabilidad de un evento (muerte), ¡aunque nunca observamos directamente ese evento!</p>
<p>Las bases y el diseño para producir datos susceptibles de análisis bajo un modelo CJS es aquel en el que se define un área de estudio fija y luego se sale y se intenta capturar y marcar tantos individuos como se definan. En ocasiones fijas, el primer registro de un individuo reconocible por sus marcas naturales o genéticas, etc. es funcionalmente idéntico al primer marcado de ese individuo. Luego, en cada ocasión, se registra la identidad de los individuos que ya tienen una marca y se coloca una nueva marca en aquellos que no la tienen. Los datos básicos se resumen en la matriz de historial de captura o detección <strong>Y</strong> de dimensiones <em>n</em> x <em>T</em>, donde <em>T</em> es el número de ocasiones Y <em>n</em> es el número de animales marcados primero hasta la ocasión <em>T</em>-1; aquellos marcados en la ocasión <em>T</em> no proporcionan ninguna información sobre la supervivencia y pueden ignorarse. La entrada (<em>i</em>,<em>t</em>) de la matriz contiene un 1 cuando el individuo <em>i</em> fue detectado en la ocasión 1 y un 0 cuando no lo fue.</p>
<p>Es crucial que la extensión espacial de un área de estudio permanezca igual a lo largo del tiempo, porque en el modelo CJS estamos estimando la supervivencia aparente: el producto de la supervivencia real (<em>S</em>) y la probabilidad de permanecer en el área de estudio (es decir, fidelidad <em>F</em>). A partir de datos simples (no espaciales) de captura-recaptura, no es posible separar estos dos componentes (aunque se hace posible con modelos CJS espacialmente explícitos. Por lo tanto, si extiende su área de estudio a lo largo del tiempo, más individuos marcados tenderán a permanecer dentro de sus límites, <em>F</em> aumentará y también lo hará la supervivencia aparente. A menudo, las ocasiones de captura se espacian regularmente, por ejemplo, durante la temporada de reproducción en cada año, pero no es necesario que así sea, y hay diferentes formas de lidiar con intervalos de tiempo desiguales. Además, lo ideal es que la captura sea instantánea y no que se extienda de forma continua en el tiempo (también existen modelos de supervivencia para datos recopilados en tiempo continuo. Por último, si queremos que nuestras estimaciones caractericen a la población en general en lugar de solo a la muestra de individuos capturados, debemos apuntar a capturar una muestra aleatoria de individuos de la población (y sin extendernos en esto, solo afirmamos que esto puede ser más desafiante de lo que parece a primera vista).</p>
<section id="modelos-básicos-de-cormack-jolly-seber" class="level2">
<h2 class="anchored" data-anchor-id="modelos-básicos-de-cormack-jolly-seber">Modelos básicos de Cormack-Jolly-Seber</h2>
<section id="el-modelo-básico-de-cjs-como-modelo-de-espacio-de-estados-o-jerárquico" class="level3">
<h3 class="anchored" data-anchor-id="el-modelo-básico-de-cjs-como-modelo-de-espacio-de-estados-o-jerárquico">El modelo básico de CJS como modelo de espacio de estados o jerárquico</h3>
<p>Fundamentalmente, el modelo CJS puede considerarse un modelo jerárquico o de espacio de estados (SSM), porque distingue entre un estado latente binario (vivo, muerto) y un estado observado binario (detectado, no detectado). La dinámica del estado latente se describe de la manera habitual de un SSM, describiendo el estado inicial de cada individuo y utilizando una regla probabilística por la que cambia de estado desde el momento <em>t</em> a <em>t</em> +1. Sin embargo, hay dos cosas un tanto peculiares. En primer lugar, el estado latente inicial de cada individuo no se modela de forma probabilística, sino que se fija en 1. Es decir, el modelo condiciona la primera captura (cuando el individuo estaba vivo por definición) y solo describe los eventos aleatorios posteriores a la primera captura. Esto es bastante diferente en otros modelos de estado sólido relacionados para respuestas binarias, como el modelo Jolly-Seber o en el modelo de ocupación dinámica, los cuales modelan una matriz de historial de detección desde el inicio (es decir, con la columna 1) de manera probabilística. En segundo lugar, en el modelo CJS, las transiciones en el estado latente solo son posibles en una dirección, de vivo a muerto. Esto es nuevamente diferente en el modelo de ocupación dinámica relacionado, donde las colonizaciones son posibles. Por último, los modelos típicos de “supervivencia del nido” o “destino conocido” difieren del modelo CJS principalmente por la ausencia de un modelo de observación, porque su estado latente se observa perfectamente si es que se observa. Todos estos modelos son equivalentes a los modelos ocultos de Markov (HMM; Zucchini et al., 2016): modelos de series temporales jerárquicos con estados discretos solamente y donde la regla de transición se refiere a un solo paso atrás en el tiempo, es decir, el modelo es markoviano de orden 1. Sin embargo, de manera un tanto confusa, la probabilidad del modelo CJS a menudo se expresa de una manera no jerárquica, en lugar de construirse de una manera jerárquica explícita. Para esto, la matriz básica del historial de captura se agrega por cohorte de liberación y ocasión de recaptura en el llamado <em>formato m-array</em>. La probabilidad de cada celda de esta matriz agregada se puede expresar como una función de parámetros específicos del tiempo de aparente supervivencia y recaptura, y el ajuste del modelo se realiza maximizando una probabilidad multinomial producto. Esta es la probabilidad maximizada en la mayoría de los programas frecuentistas para el modelo CJS.</p>
<p>Con el formato m-array, la probabilidad CJS se colapsa sobre los estados latentes <em>z</em> (ver más abajo) y, por lo tanto, en un sentido técnico, el modelo ya no es jerárquico, aunque conceptualmente lo es. En cambio, en programas bayesianos como BUGS, podemos ajustar el modelo tanto utilizando la construcción jerárquica directa de la probabilidad, como utilizando la agregación de matriz m-array. Podría decirse que la primera es conceptualmente más fácil de entender y, además, permite ajustar modelos más generales, pero la segunda es computacionalmente más eficiente (y a menudo mucho más eficiente).</p>
<p>En el formato SSM, los datos de historial de captura observados y, son iguales a 1 si el individuo <em>i</em> es detectado (es decir, capturado) en la ocasión <em>t</em> y 0 si no es detectado. Se describen en términos de una variable latente <span class="math inline">\(z_{i,t}\)</span>, que dice si ese individuo estaba vivo (<span class="math inline">\(z_{i,t} = 1\)</span>) o muerto (<span class="math inline">\(z_{i,t} = 0\)</span>) en la ocasión <em>t</em>, y dos parámetros, las probabilidades de supervivencia aparente <span class="math inline">\(\phi\)</span> y de recaptura <span class="math inline">\(p\)</span>, que, para mayor claridad, aquí asumimos primero que son constantes. Dado que el modelo CJS se define condicional a la primera captura y se conoce el estado verdadero en la primera captura, también necesitamos un vector que contenga la ocasión de marcado, llamado <span class="math inline">\(f\)</span>, para describir los datos observados de manera probabilística, es decir, para formar su probabilidad. Luego, describimos la parte latente del sistema en dos líneas:</p>
<p><span class="math inline">\(z_{i,f = 1}\)</span> (para la ocasión de marcado)</p>
<p><span class="math inline">\(z_{i,t+1}|z_{i,t} \sim Bernoulli(z_{i,1}\phi)\)</span> (para todas las ocasiones posteriores)</p>
<p>Por lo tanto, después de la ocasión de marcado, el estado vivo/muerto es un simple ensayo de Bernoulli condicional con probabilidad de éxito <span class="math inline">\(z_i\phi\)</span>; la multiplicación con <span class="math inline">\(z_i\)</span>, asegura que el individuo <span class="math inline">\(i\)</span> permanezca muerto una vez que haya muerto. Este es el submodelo de proceso del modelo jerárquico. Para describir el proceso de observación, asumimos que no hay falsos positivos (por ejemplo, ninguna marca se identifica erróneamente) y adoptamos otra distribución de Bernoulli (condicional).</p>
<p><span class="math inline">\(y_{i,t}|z_{i,t}\sim Bernoulli(z_{i,t}p)\)</span> El (sub)modelo de observación</p>
<p>Por lo tanto, que un individuo sea detectado o no depende de dos cosas: si está vivo y de la probabilidad de recaptura <span class="math inline">\(p\)</span>. En el caso más general, podemos permitir que ambos parámetros del modelo difieran según el individuo <span class="math inline">\(i\)</span> y el tiempo <span class="math inline">\(t\)</span> y, a continuación, se puede especificar una gran cantidad de patrones para ellos agregando efectos de covariables o efectos aleatorios. Un conjunto de presencia o ausencia de efectos temporales conduce a la clasificación clásica de modelos <span class="math inline">\(\phi(t)p(t)\)</span>, <span class="math inline">\(\phi(t)p(.)\)</span>, <span class="math inline">\(\phi(.)p(t)\)</span>, <span class="math inline">\(\phi(.)p(.)\)</span> clasificación de modelos con parámetros que son constantes (.) o totalmente dependientes del tiempo (<span class="math inline">\(t\)</span>) (Cooch y White, 2019).</p>
<p>Referencia, Capítulo 3: <a href="https://www.sciencedirect.com/book/9780128237687/applied-hierarchical-modeling-in-ecology-analysis-of-distribution-abundance-and-species-richness-in-r-and-bugs">Aplied Hierarchical Modeling in Ecology, Volumen 2</a></p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Datos sobre el GWWA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Preparar lista</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Null model</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">Canopy as predicted</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">Grafico</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>encounter_matrix <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/GWWA_CR.rds"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>Hab <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/Hab.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jagsUI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ch <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(encounter_matrix[,<span class="dv">3</span><span class="sc">:</span><span class="dv">43</span>])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sites <span class="ot">&lt;-</span> encounter_matrix<span class="sc">$</span>Site_Value</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get sample size</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>(nweeks <span class="ot">&lt;-</span> <span class="fu">ncol</span>(ch))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>(nsites <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">data.frame</span>(encounter_matrix<span class="sc">$</span>Site_Value)))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(AHMbook)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ch2marray</span>(ch)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>marr <span class="ot">&lt;-</span> <span class="fu">ch2marray</span>(ch) </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of birds released each week</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">apply</span>(marr, <span class="dv">1</span>, sum)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>MARR <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">40</span>, nweeks,nsites))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">40</span>, nsites))</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nsites){</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  ma <span class="ot">&lt;-</span> <span class="fu">ch2marray</span>(ch)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  MARR[,,k] <span class="ot">&lt;-</span> ma</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  R[,k] <span class="ot">&lt;-</span> <span class="fu">apply</span>(ma, <span class="dv">1</span>, sum)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(bdata <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">MARR =</span> MARR, <span class="at">R =</span> R, <span class="at">n.site =</span> nsites, <span class="at">n.occ =</span> nweeks,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Canopy =</span> Hab<span class="sc">$</span>Canopy, <span class="at">Vine =</span> Hab<span class="sc">$</span>Vine, <span class="at">Leaf =</span> Hab<span class="sc">$</span>Leaf ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="at">file =</span> <span class="st">"Survival1.txt"</span>, <span class="st">"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="st">  # Priors for constant survival and recapture</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="st">  for (t in 1:(n.occ-1)){</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">    phi[t] &lt;- ilogit(mu.lphi)  # constant survival</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">    p[t] &lt;- ilogit(mu.lp)      # constant recapture</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="st">  # Hyperpriors for global parameters (mean survival and recapture)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="st">  mu.lphi ~ dunif(0, 1)  # Uniform prior for mean survival</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="st">  mu.lp ~ dunif(0, 1)    # Uniform prior for mean recapture</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="st">  # Likelihood for the m-array data (no random effects)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="st">  for (s in 1:n.site){</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="st">    for (t in 1:(n.occ-1)){</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="st">      MARR[t, 1:n.occ, s] ~ dmulti(pr[t, 1:n.occ, s], R[t, s])</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="st">  # Define the cell probabilities of the m-array (constant survival and recapture)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="st">  for (t in 1:(n.occ-1)){</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="st">    q[t] &lt;- 1 - p[t]</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="st">  for (s in 1:n.site){</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="st">    for (t in 1:(n.occ-1)){</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="st">      pr[t, t, s] &lt;- phi[t] * p[t]  # Probability of recapture</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="st">      # Above diagonal: only calculate if j &lt;= n.occ-1</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in (t+1):(n.occ-1)){</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="st">        pr[t, j, s] &lt;- prod(phi[t:j]) * prod(q[t:(j-1)]) * p[j]</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="st">      # Ensure valid probabilities for the last column (j = n.occ)</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="st">      pr[t, n.occ, s] &lt;- 1 - sum(pr[t, 1:(n.occ-1), s])</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="st">      # Below diagonal (no recapture)</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in 1:(t-1)){</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="st">        pr[t, j, s] &lt;- 0</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="cf">function</span>() {<span class="fu">list</span>(<span class="at">pNorm =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="fl">0.2</span>, <span class="fl">0.8</span>), </span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>                          <span class="at">phiWithin=</span><span class="fu">runif</span>(<span class="dv">2</span>, <span class="fl">0.8</span>,<span class="dv">1</span>), </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                          <span class="at">phiAmong=</span><span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.2</span>,<span class="fl">0.8</span>))}</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters monitored</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mu.lphi"</span>, <span class="st">"mu.lp"</span>)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMC settings</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co"># na &lt;- 1000 ; ni &lt;- 30000 ; nt &lt;- 10 ; nb &lt;- 20000 ; nc &lt;- 3</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>na <span class="ot">&lt;-</span> <span class="dv">100</span> ; ni <span class="ot">&lt;-</span> <span class="dv">300</span> ; nt <span class="ot">&lt;-</span> <span class="dv">1</span> ; nb <span class="ot">&lt;-</span> <span class="dv">200</span> ; nc <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># ~~~ for testing</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Call JAGS (ART 192 min), check convergence and summarize posteriors</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">jags</span>(bdata, inits, params, <span class="st">"Survival1.txt"</span>, <span class="at">n.adapt =</span> na, <span class="at">n.chains =</span> nc,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>             <span class="at">n.thin =</span> nt, <span class="at">n.iter =</span> ni, <span class="at">n.burnin =</span> nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Processing function input....... 

Done. 
 
Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 1600
   Unobserved stochastic nodes: 2
   Total graph size: 13433

Initializing model

Adaptive phase, 100 iterations x 3 chains 
If no progress bar appears JAGS has decided not to adapt 
 

 Burn-in phase, 200 iterations x 3 chains 
 

Sampling from joint posterior, 100 iterations x 3 chains 
 

Calculating statistics....... 

Done. </code></pre>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data structure for JAGS model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(bdata <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">MARR =</span> MARR, <span class="at">R =</span> R, <span class="at">n.site =</span> nsites, <span class="at">n.occ =</span> nweeks,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Canopy =</span> Hab<span class="sc">$</span>Canopy, <span class="at">Vine =</span> Hab<span class="sc">$</span>Vine, <span class="at">Leaf =</span> Hab<span class="sc">$</span>Leaf))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 7
 $ MARR  : num [1:40, 1:41, 1:40] 1 0 0 0 0 0 0 0 0 0 ...
 $ R     : num [1:40, 1:40] 1 6 3 10 9 8 3 5 3 8 ...
 $ n.site: int 40
 $ n.occ : int 41
 $ Canopy: num [1:40] 18.25 8.67 19.88 10.67 7.29 ...
 $ Vine  : num [1:40] 1 0.636 1.429 0.333 0.833 ...
 $ Leaf  : num [1:40] 2.12 2.25 2 1.86 1.57 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the model in BUGS language</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="at">file =</span> <span class="st">"cjs_canopy_model.txt"</span>, <span class="st">"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">  # Priors and linear models</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">  for (s in 1:n.site) {</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="st">    for (t in 1:(n.occ-1)) {</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">      phi[t, s] &lt;- ilogit(lphi[t, s])  # Survival</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st">      p[t, s] &lt;- ilogit(lp[t, s])      # Recapture</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="st">      # Linear predictor for survival using Canopy, Vine, and Leaf as covariates</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">      lphi[t, s] &lt;- alpha.mu.lphi + beta1 * Canopy[s] + beta2 * Vine[s] + beta3 * Leaf[s]</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="st">      # Simplified recapture model (can be modified if needed)</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="st">      lp[t, s] &lt;- mu.lp</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="st">    # Back-transform site means</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="st">    mean.phi.site[s] &lt;- ilogit(alpha.mu.lphi + beta1 * Canopy[s] + beta2 * Vine[s] + beta3 * Leaf[s])</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="st">    mean.p.site[s] &lt;- ilogit(mu.lp)</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="st">  # Hyperpriors</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha.mu.lphi &lt;- logit(mean.phi)</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="st">  mean.phi ~ dunif(0, 1)</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="st">  mu.lp &lt;- logit(mean.p)</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="st">  mean.p ~ dunif(0, 1)</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="st">  # Coefficients for Canopy, Vine, and Leaf</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="st">  beta1 ~ dnorm(0, 0.1)</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="st">  beta2 ~ dnorm(0, 0.1)</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="st">  beta3 ~ dnorm(0, 0.1)</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="st">  # Multinomial likelihood for m-array data</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="st">  for (s in 1:n.site) {</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="st">    for (t in 1:(n.occ-1)) {</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="st">      MARR[t, 1:n.occ, s] ~ dmulti(pr[t, , s], R[t, s])</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="st">  # Define cell probabilities for the m-array</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="st">  for (s in 1:n.site) {</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="st">    for (t in 1:(n.occ-1)) {</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="st">      q[t, s] &lt;- 1 - p[t, s]  # Probability of non-recapture</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="st">      pr[t, t, s] &lt;- phi[t, s] * p[t, s]</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in (t+1):(n.occ-1)) {</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="st">        pr[t, j, s] &lt;- prod(phi[t:j, s]) * prod(q[t:(j-1), s]) * p[j, s]</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="st">      for (j in 1:(t-1)) {</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="st">        pr[t, j, s] &lt;- 0</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="st">  # Last column: probability of non-recapture</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="st">  for (s in 1:n.site) {</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="st">    for (t in 1:(n.occ-1)) {</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="st">      pr[t, n.occ, s] &lt;- 1 - sum(pr[t, 1:(n.occ-1), s])</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta1 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),     <span class="co"># Initial value for Canopy effect</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta2 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),     <span class="co"># Initial value for Vine effect</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta3 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),     <span class="co"># Initial value for Leaf effect</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean.phi =</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),  <span class="co"># Mean survival on probability scale</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean.p =</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)     <span class="co"># Mean recapture on probability scale</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>  <span class="st">"beta1"</span>,            <span class="co"># Effect of Canopy</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>  <span class="st">"beta2"</span>,            <span class="co"># Effect of Vine</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  <span class="st">"beta3"</span>,            <span class="co"># Effect of Leaf</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mean.phi"</span>,         <span class="co"># Mean survival probability</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mean.p"</span>,           <span class="co"># Mean recapture probability</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mean.phi.site"</span>,    <span class="co"># Site-level survival probabilities</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mean.p.site"</span>       <span class="co"># Site-level recapture probabilities</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">jags</span>(bdata, inits, parameters, <span class="st">"cjs_canopy_model.txt"</span>, <span class="at">n.adapt =</span> na, <span class="at">n.chains =</span> nc,</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>             <span class="at">n.thin =</span> nt, <span class="at">n.iter =</span> ni, <span class="at">n.burnin =</span> nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Processing function input....... 

Done. 
 
Compiling model graph
   Resolving undeclared variables
   Allocating nodes
Graph information:
   Observed stochastic nodes: 1600
   Unobserved stochastic nodes: 5
   Total graph size: 162832

Initializing model

Adaptive phase, 100 iterations x 3 chains 
If no progress bar appears JAGS has decided not to adapt 
 

 Burn-in phase, 200 iterations x 3 chains 
 

Sampling from joint posterior, 100 iterations x 3 chains 
 

Calculating statistics....... 

Done. </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>model2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>JAGS output for model 'cjs_canopy_model.txt', generated by jagsUI.
Estimates based on 3 chains of 300 iterations,
adaptation = 100 iterations (sufficient),
burn-in = 200 iterations and thin rate = 1,
yielding 300 total samples from the joint posterior. 
MCMC ran for 6.354 minutes at time 2024-11-29 16:02:26.837189.

                       mean      sd      2.5%       50%     97.5% overlap0
beta1                -0.001   0.017    -0.019    -0.002     0.022     TRUE
beta2                -0.017   0.101    -0.193    -0.018     0.194     TRUE
beta3                 0.146   0.271    -0.166     0.072     0.886     TRUE
mean.phi              0.910   0.058     0.733     0.931     0.950    FALSE
mean.p                0.169   0.009     0.142     0.171     0.177    FALSE
mean.phi.site[1]      0.937   0.007     0.930     0.936     0.952    FALSE
mean.phi.site[2]      0.939   0.007     0.930     0.939     0.957    FALSE
mean.phi.site[3]      0.935   0.008     0.924     0.934     0.954    FALSE
mean.phi.site[4]      0.937   0.004     0.929     0.937     0.943    FALSE
mean.phi.site[5]      0.934   0.007     0.916     0.936     0.941    FALSE
mean.phi.site[6]      0.940   0.012     0.925     0.939     0.979    FALSE
mean.phi.site[7]      0.929   0.015     0.883     0.934     0.944    FALSE
mean.phi.site[8]      0.936   0.004     0.931     0.935     0.941    FALSE
mean.phi.site[9]      0.942   0.011     0.926     0.939     0.969    FALSE
mean.phi.site[10]     0.937   0.003     0.933     0.937     0.944    FALSE
mean.phi.site[11]     0.940   0.008     0.927     0.939     0.964    FALSE
mean.phi.site[12]     0.931   0.010     0.905     0.933     0.943    FALSE
mean.phi.site[13]     0.936   0.009     0.913     0.937     0.946    FALSE
mean.phi.site[14]     0.938   0.005     0.928     0.938     0.950    FALSE
mean.phi.site[15]     0.935   0.008     0.917     0.937     0.942    FALSE
mean.phi.site[16]     0.937   0.007     0.923     0.938     0.946    FALSE
mean.phi.site[17]     0.936   0.002     0.932     0.936     0.941    FALSE
mean.phi.site[18]     0.934   0.008     0.916     0.935     0.944    FALSE
mean.phi.site[19]     0.932   0.011     0.903     0.934     0.947    FALSE
mean.phi.site[20]     0.934   0.006     0.917     0.935     0.941    FALSE
mean.phi.site[21]     0.935   0.006     0.923     0.935     0.943    FALSE
mean.phi.site[22]     0.938   0.010     0.927     0.936     0.973    FALSE
mean.phi.site[23]     0.939   0.005     0.931     0.938     0.952    FALSE
mean.phi.site[24]     0.938   0.004     0.932     0.938     0.947    FALSE
mean.phi.site[25]     0.937   0.004     0.932     0.936     0.945    FALSE
mean.phi.site[26]     0.934   0.007     0.911     0.935     0.941    FALSE
mean.phi.site[27]     0.939   0.006     0.932     0.937     0.953    FALSE
mean.phi.site[28]     0.940   0.010     0.927     0.938     0.965    FALSE
mean.phi.site[29]     0.934   0.007     0.916     0.935     0.945    FALSE
mean.phi.site[30]     0.931   0.013     0.891     0.935     0.942    FALSE
mean.phi.site[31]     0.935   0.003     0.929     0.936     0.940    FALSE
mean.phi.site[32]     0.934   0.006     0.918     0.936     0.941    FALSE
mean.phi.site[33]     0.938   0.003     0.933     0.937     0.948    FALSE
mean.phi.site[34]     0.936   0.004     0.931     0.936     0.947    FALSE
mean.phi.site[35]     0.937   0.007     0.923     0.937     0.945    FALSE
mean.phi.site[36]     0.935   0.009     0.921     0.934     0.956    FALSE
mean.phi.site[37]     0.935   0.006     0.924     0.934     0.943    FALSE
mean.phi.site[38]     0.937   0.005     0.932     0.937     0.950    FALSE
mean.phi.site[39]     0.937   0.007     0.926     0.937     0.960    FALSE
mean.phi.site[40]     0.941   0.010     0.929     0.938     0.963    FALSE
mean.p.site[1]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[2]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[3]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[4]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[5]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[6]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[7]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[8]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[9]        0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[10]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[11]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[12]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[13]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[14]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[15]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[16]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[17]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[18]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[19]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[20]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[21]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[22]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[23]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[24]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[25]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[26]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[27]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[28]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[29]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[30]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[31]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[32]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[33]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[34]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[35]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[36]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[37]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[38]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[39]       0.169   0.009     0.142     0.171     0.177    FALSE
mean.p.site[40]       0.169   0.009     0.142     0.171     0.177    FALSE
deviance          16287.862 107.733 16257.183 16261.569 16511.680    FALSE
                      f  Rhat n.eff
beta1             0.683 1.243   144
beta2             0.633 1.241    30
beta3             0.693 2.001     5
mean.phi          1.000 1.798     6
mean.p            1.000 1.341    21
mean.phi.site[1]  1.000 1.351    15
mean.phi.site[2]  1.000 1.574     8
mean.phi.site[3]  1.000 1.224   300
mean.phi.site[4]  1.000 1.104    71
mean.phi.site[5]  1.000 1.748     6
mean.phi.site[6]  1.000 1.429    11
mean.phi.site[7]  1.000 1.925     6
mean.phi.site[8]  1.000 1.208   180
mean.phi.site[9]  1.000 1.992     5
mean.phi.site[10] 1.000 1.191    54
mean.phi.site[11] 1.000 1.433    10
mean.phi.site[12] 1.000 1.730     7
mean.phi.site[13] 1.000 1.238   252
mean.phi.site[14] 1.000 1.182    17
mean.phi.site[15] 1.000 1.289    36
mean.phi.site[16] 1.000 1.214   300
mean.phi.site[17] 1.000 1.062    57
mean.phi.site[18] 1.000 1.342    18
mean.phi.site[19] 1.000 1.451    11
mean.phi.site[20] 1.000 1.822     6
mean.phi.site[21] 1.000 1.281    34
mean.phi.site[22] 1.000 1.315    22
mean.phi.site[23] 1.000 1.541     8
mean.phi.site[24] 1.000 1.461     8
mean.phi.site[25] 1.000 1.257    46
mean.phi.site[26] 1.000 1.580     8
mean.phi.site[27] 1.000 1.735     6
mean.phi.site[28] 1.000 1.763     6
mean.phi.site[29] 1.000 1.426    10
mean.phi.site[30] 1.000 1.627     8
mean.phi.site[31] 1.000 1.292    16
mean.phi.site[32] 1.000 1.764     6
mean.phi.site[33] 1.000 1.370    11
mean.phi.site[34] 1.000 1.185   300
mean.phi.site[35] 1.000 1.211   300
mean.phi.site[36] 1.000 1.230   300
mean.phi.site[37] 1.000 1.223    80
mean.phi.site[38] 1.000 1.293    29
mean.phi.site[39] 1.000 1.142    55
mean.phi.site[40] 1.000 1.933     5
mean.p.site[1]    1.000 1.341    21
mean.p.site[2]    1.000 1.341    21
mean.p.site[3]    1.000 1.341    21
mean.p.site[4]    1.000 1.341    21
mean.p.site[5]    1.000 1.341    21
mean.p.site[6]    1.000 1.341    21
mean.p.site[7]    1.000 1.341    21
mean.p.site[8]    1.000 1.341    21
mean.p.site[9]    1.000 1.341    21
mean.p.site[10]   1.000 1.341    21
mean.p.site[11]   1.000 1.341    21
mean.p.site[12]   1.000 1.341    21
mean.p.site[13]   1.000 1.341    21
mean.p.site[14]   1.000 1.341    21
mean.p.site[15]   1.000 1.341    21
mean.p.site[16]   1.000 1.341    21
mean.p.site[17]   1.000 1.341    21
mean.p.site[18]   1.000 1.341    21
mean.p.site[19]   1.000 1.341    21
mean.p.site[20]   1.000 1.341    21
mean.p.site[21]   1.000 1.341    21
mean.p.site[22]   1.000 1.341    21
mean.p.site[23]   1.000 1.341    21
mean.p.site[24]   1.000 1.341    21
mean.p.site[25]   1.000 1.341    21
mean.p.site[26]   1.000 1.341    21
mean.p.site[27]   1.000 1.341    21
mean.p.site[28]   1.000 1.341    21
mean.p.site[29]   1.000 1.341    21
mean.p.site[30]   1.000 1.341    21
mean.p.site[31]   1.000 1.341    21
mean.p.site[32]   1.000 1.341    21
mean.p.site[33]   1.000 1.341    21
mean.p.site[34]   1.000 1.341    21
mean.p.site[35]   1.000 1.341    21
mean.p.site[36]   1.000 1.341    21
mean.p.site[37]   1.000 1.341    21
mean.p.site[38]   1.000 1.341    21
mean.p.site[39]   1.000 1.341    21
mean.p.site[40]   1.000 1.341    21
deviance          1.000 1.409    17

**WARNING** Rhat values indicate convergence failure. 
Rhat is the potential scale reduction factor (at convergence, Rhat=1). 
For each parameter, n.eff is a crude measure of effective sample size. 

overlap0 checks if 0 falls in the parameter's 95% credible interval.
f is the proportion of the posterior with the same sign as the mean;
i.e., our confidence that the parameter is positive or negative.

DIC info: (pD = var(deviance)/2) 
pD = 5102.8 and DIC = 21390.62 
DIC is an estimate of expected predictive error (lower is better).</code></pre>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>Canopy <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(Hab<span class="sc">$</span>Canopy), <span class="fu">max</span>(Hab<span class="sc">$</span>Canopy), <span class="at">length =</span><span class="dv">100</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>Canopy_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Predicted =</span> <span class="fu">plogis</span>(<span class="fu">mean</span>(model2<span class="sc">$</span>mean<span class="sc">$</span>mean.phi) <span class="sc">+</span>  <span class="fu">mean</span>(model2<span class="sc">$</span>mean<span class="sc">$</span>beta1)<span class="sc">*</span>Canopy),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">IC2.5 =</span> <span class="fu">plogis</span>(<span class="fu">mean</span>(model2<span class="sc">$</span>q2<span class="fl">.5</span><span class="sc">$</span>mean.phi) <span class="sc">+</span>  <span class="fu">mean</span>(model2<span class="sc">$</span>q2<span class="fl">.5</span><span class="sc">$</span>beta1)<span class="sc">*</span>Canopy),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">IC97.5 =</span> <span class="fu">plogis</span>(<span class="fu">mean</span>(model2<span class="sc">$</span>q97<span class="fl">.5</span><span class="sc">$</span>mean.phi) <span class="sc">+</span>  <span class="fu">mean</span>(model2<span class="sc">$</span>q97<span class="fl">.5</span><span class="sc">$</span>beta1)<span class="sc">*</span>Canopy),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Canopy =</span>  Canopy)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Canopy_df, <span class="fu">aes</span>(<span class="at">x=</span> Canopy, <span class="at">y =</span> Predicted))<span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin=</span> IC2<span class="fl">.5</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax=</span> IC97<span class="fl">.5</span>),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha=</span> <span class="fl">0.4</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>)<span class="sc">+</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Supervivencia diaria"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">x=</span> <span class="st">"Altura de canopy"</span>)<span class="sc">+</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Clase8_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>