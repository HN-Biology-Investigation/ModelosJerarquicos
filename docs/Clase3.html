<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Murillo">

<title>Clase 3: Modelar abundancia con muestreo de distancia jerárquico</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Clase3_files/libs/clipboard/clipboard.min.js"></script>
<script src="Clase3_files/libs/quarto-html/quarto.js"></script>
<script src="Clase3_files/libs/quarto-html/popper.min.js"></script>
<script src="Clase3_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Clase3_files/libs/quarto-html/anchor.min.js"></script>
<link href="Clase3_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Clase3_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Clase3_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Clase3_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Clase3_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Clase 3: Modelar abundancia con muestreo de distancia jerárquico</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Murillo </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>El muestreo por distancias (Distance Sampling, DS) es uno de los métodos estadísticos más utilizados en ecología para estimar la densidad o el tamaño poblacional (Burnham et al., 1980; Buckland et al., 2001, 2004a; Williams et al., 2002). El muestreo por distancias convencional (CDS: Buckland et al., 2001) utiliza información sobre distancias observadas para estimar la probabilidad de detección, agrupando los datos entre unidades de muestreo. Por otro lado, en un marco jerárquico formal, se emplean modelos paramétricos para describir la variación en la abundancia entre unidades de muestreo. Siguiendo las ideas básicas de los capítulos 6 y 7, tiene sentido proporcionar un modelo explícito para la variación del tamaño poblacional local <em>N</em>, es decir, el tamaño poblacional en las unidades de muestreo espacial. A este enfoque lo denominamos “muestreo por distancias jerárquico” (HDS). Al especificar un modelo para esta variable latente, se pueden construir modelos explícitos para los datos de muestreo por distancias que consideren la variación en el tamaño poblacional (o la densidad local) entre unidades de muestreo, facilitando así la inferencia sobre factores que influyen en la variación espacial de la abundancia o permitiendo realizar predicciones espaciales explícitas de la abundancia.</p>
<p>Aunque el muestreo por distancias convencional está muy consolidado en ecología y ciencias de la vida silvestre, el HDS ha existido solo durante unos pocos años. Dos artículos clave han desarrollado las ideas del HDS. Hedley y Buckland (2004) adoptaron un procedimiento de estimación en dos etapas: primero, emplearon el modelo habitual de muestreo por distancias para estimar la probabilidad de detección agrupando los datos entre unidades de muestreo y, en una segunda etapa, ajustaron un modelo (por ejemplo, un GLM de Poisson con un offset basado en la probabilidad de detección) al conteo observado de individuos <em>n</em> para cada una de las <em>S</em> unidades de muestreo. Miller et al.&nbsp;(2013a) denominaron a esta metodología “modelado de superficies de densidad” (Density Surface Modeling) y describieron un paquete en R llamado dsm e implementado en el popular programa Distance (Thomas et al., 2010).</p>
<p>Royle et al.&nbsp;(2004) desarrollaron el HDS como un modelo jerárquico formal en el que los dos componentes (detección y abundancia) se estiman simultáneamente en un solo modelo jerárquico, análogo al marco de modelos de mezcla binomial o multinomial <em>N</em>. La metodología HDS se implementa en unmarked utilizando las funciones distsamp y gdist.</p>
<p>El método CDS tiene cuatro supuestos principales: (1) los animales están distribuidos uniformemente en el espacio; (2) la probabilidad de detección es función de la distancia y es igual a 1 en distancia 0; (3) los individuos son detectados en su ubicación original, es decir, no hay movimiento de respuesta; y (4) las distancias se miden sin error. Generalmente, el supuesto (1) no se declara explícitamente, pero se asume que los puntos o transectos de muestreo están distribuidos aleatoriamente (Buckland et al., 2001, p.&nbsp;29).</p>
<section id="muestreo-por-distancias-convencional" class="level2">
<h2 class="anchored" data-anchor-id="muestreo-por-distancias-convencional">Muestreo por distancias convencional</h2>
<p>Primero desarrollamos los conceptos básicos y los detalles técnicos del muestreo de distancias “clásico”, considerando la replicación espacial y los modelos jerárquicos. Una forma sencilla de motivar el muestreo de distancias es pensar en nuestro estimador heurístico de <em>N</em>, derivado al resolver la relación:</p>
<p><span class="math display">\[E(n) = pN\]</span> Por lo tanto, podemos estimar <em>N</em> a partir de un conteo de muestra y una probabilidad de detección <em>p</em>, que describe la probabilidad de que un objeto (o animal) aparezca en nuestra muestra. La idea principal es estimar la probabilidad de detección de objetos como una función de la distancia, especificando una función de detección <em>g(x; θ)</em>, que describe la probabilidad de detección en función de la distancia (<em>x</em>) y de un parámetro (<em>θ</em>). De esta forma, la función de detección es un modelo para la probabilidad de detección de un objeto, condicionada a su distancia del observador <em>x</em>, ejemplo <em>g(x,θ)=P(y=1|x)</em>, en nuestro concepto habitual de probabilidades condicionales, donde <em>y</em> es una variable de Bernoulli que indica detección (<em>y=1</em>) o no detección (<em>y=0</em>).</p>
<p>La notación tradicional puede resultar un poco confusa porque si solo escribimos <em>g(x;θ)</em>, podría parecer una distribución de probabilidad para <em>x</em>, lo cual no es correcto. Más bien, representa el parámetro de una función de masa de probabilidad de Bernoulli para la variable <em>y</em>, es decir, si un objeto es detectado o no, condicionado a <em>x</em>. Por esta razón, cuando queremos ser claros, escribimos esto como <em>P(y=1∣x</em>), para indicar que se trata de la probabilidad de un evento, es decir, ser detectado.</p>
<p>¿Cómo se relaciona <em>p</em> con la función de detección <em>g(x;θ)</em>?</p>
<p>Es la probabilidad de detección marginal o promedio (es decir, <em>p</em>), que es la probabilidad de que un individuo en la población general aparezca en la muestra. Esto se calcula promediando <em>g(x;θ)</em> sobre todos los valores posibles de <em>x</em>.</p>
<p>Formalmente, el cálculo es:</p>
<p><span class="math display">\[p \equiv Pr(y=1) = \int g(x; \theta)[x] \, dx\]</span></p>
<p>Nota que el promedio se realiza con respecto a la densidad de probabilidad para <em>x</em>, denotada aquí como <em>[x]</em> (usando la notación de corchetes establecida), aunque aún no hemos especificado esta cantidad. Por lo tanto, el modelo básico de muestreo por distancia tiene dos componentes explícitos y esenciales:</p>
<ol type="1">
<li><p>El “modelo de observación”, que describe cómo los individuos aparecen en la muestra, caracterizado por la función <em>g(x;θ)</em>.</p></li>
<li><p>El “modelo de proceso” [<em>x</em>], que describe cómo los objetos en la población están distribuidos con respecto al observador o al transecto.</p></li>
</ol>
</section>
<section id="muestreo-por-distancia-jerárquico-hds." class="level2">
<h2 class="anchored" data-anchor-id="muestreo-por-distancia-jerárquico-hds.">Muestreo por distancia jerárquico (HDS).</h2>
<p>Ahora pasamos de los elementos básicos de los modelos convencionales de muestreo por distancia a situaciones en las que se tienen datos de muestreo por distancia recopilados en <em>S</em> ubicaciones espaciales, generalmente en transectos o puntos de conteo, aunque también podríamos tener una mezcla de ambos, o incluso formas inusuales o transectos irregulares. La forma tradicional de abordar esto en el muestreo por distancia es agrupar los datos de distancia de las <em>S</em> ubicaciones espaciales y estimar el/los parámetro(s) de la función de detección, por ejemplo, <em>σ</em> para un modelo medio-normal. Esto se utiliza para obtener una estimación de la densidad, y luego la varianza se basa en la varianza de la tasa de encuentros, que sí utiliza algo de información de las unidades de muestreo. Sin embargo, el muestreo por distancia convencional no aborda directamente los problemas de inferencia espacial, ya sea en términos de modelar las ubicaciones de los puntos o la densidad local entre unidades de muestreo, o de hacer predicciones explícitas en otros transectos o ubicaciones de puntos. Argumentamos que modelar la variación en <em>N</em> entre las unidades de muestreo es fundamental y, de hecho, a menudo es el principal interés en los estudios que usan el muestreo por distancia. Por lo tanto, los modelos HDS deberían estar en la caja de herramientas de todo ecólogo.</p>
<p>Los modelos que tratamos aquí asumen que <em>Ns</em> es el tamaño poblacional de la unidad de muestreo espacial <em>s</em>, y no hacen supuestos explícitos sobre la variación de la densidad “dentro de la unidad de muestreo”. Más bien, asumen que el valor promedio de las covariables definido para la unidad de muestreo es significativo para explicar la variación entre las unidades de muestreo. Así, cuando asumimos que <em>Ns∼Poisson(λs)</em>, el parámetro <em>λs</em> es constante para las ubicaciones de muestreo y representa la media para la unidad de muestreo. Esto no significa que los modelos HDS asuman que la densidad es constante dentro de una unidad de muestreo, sino que la densidad agregada se modela adecuadamente con las covariables definidas para la unidad de muestreo.</p>
</section>
<section id="ejercicio-estimación-del-tamaño-de-la-población-global-del-island-scrub-jay-issj" class="level2">
<h2 class="anchored" data-anchor-id="ejercicio-estimación-del-tamaño-de-la-población-global-del-island-scrub-jay-issj">Ejercicio: estimación del tamaño de la población global del island scrub-jay (issj)</h2>
<p>El Island scrub-jay (<em>Aphelocoma insularis</em>) es una especie endémica de la Isla Santa Cruz, California, y de interés para la conservación por parte del Servicio de Parques Nacionales (NPS) y otras organizaciones debido a su distribución extremadamente localizada y a informes previos sobre tamaños poblacionales bajos y en declive. T. S. Sillett y otros iniciaron un muestreo a nivel de toda la isla en 2008 para obtener una estimación estadística del tamaño poblacional. El estudio fue reportado en Sillett et al.&nbsp;(2012). Los datos del Island scrub-jay están disponibles en unmarked con el comando data(fssj).</p>
<p>Los datos corresponden a conteos puntuales de muestreo por distancia en 307 ubicaciones de conteo, con conteos realizados hasta 300 m de distancia. Para el análisis, los datos originales de distancia fueron agrupados en tres clases de 100 m, ya que se observó que los pájaros cercanos respondían al observador (acercándose, lo que representaba un movimiento de respuesta). Se consideró que las clases de distancia amplias deberían mitigar ese efecto.</p>
<p>Los objetivos del estudio fueron:</p>
<ul>
<li><p>Estimar el tamaño global de la población.</p></li>
<li><p>Hacer predicciones de <em>E(N)</em> bajo paisajes alternativos o históricos.</p></li>
</ul>
<p>Hasta hace poco, la isla había sido intensamente pastoreada por ganado, pero un esfuerzo intenso de erradicación eliminó exitosamente el ganado, lo que permitió que la vegetación volviera a condiciones históricas. Sin embargo, contamos con un mapa de vegetación de la isla en su estado de intenso pastoreo, y queremos hacer una declaración hipotética sobre cuántos scrub-jays podrían haber existido bajo esas condiciones.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Cargar paquete</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Cargar base de datos</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Prepara data en formato unmarked</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">Ajustar modelos</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">Seleccionar modelo mas adecuado</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false" href="">Validar modelo</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" role="tab" aria-controls="tabset-1-7" aria-selected="false" href="">Poblacion esperada</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-8" role="tab" aria-controls="tabset-1-8" aria-selected="false" href="">Prepara para graficar</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-9" role="tab" aria-controls="tabset-1-9" aria-selected="false" href="">Graficar</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(unmarked)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(AICcmodavg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(issj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(issj[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(issj[,<span class="fu">c</span>(<span class="st">"elevation"</span>, <span class="st">"forest"</span>, <span class="st">"chaparral"</span>)])</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>area <span class="ot">&lt;-</span> pi<span class="sc">*</span><span class="dv">300</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">100</span><span class="sc">^</span><span class="dv">2</span> <span class="co"># area en hectareas</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>jay_umf <span class="ot">&lt;-</span> <span class="fu">unmarkedFrameDS</span>(<span class="at">y =</span> y,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">siteCovs =</span> covs,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">dist.breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">unitsIn =</span> <span class="st">"m"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">survey =</span> <span class="st">"point"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>jay_m1 <span class="ot">&lt;-</span> <span class="fu">distsamp</span>(<span class="sc">~</span>chaparral <span class="sc">~</span>chaparral <span class="sc">+</span> elevation,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> jay_umf, <span class="at">keyfun =</span> <span class="st">"halfnorm"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">output =</span> <span class="st">"abund"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(jay_m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
distsamp(formula = ~chaparral ~ chaparral + elevation, data = jay_umf, 
    keyfun = "halfnorm", output = "abund")

Abundance (log-scale):
            Estimate       SE      z  P(&gt;|z|)
(Intercept) -0.17551 0.311368 -0.564 5.73e-01
chaparral    4.12031 0.621641  6.628 3.40e-11
elevation   -0.00205 0.000724 -2.832 4.63e-03

Detection (log-scale):
            Estimate    SE    z   P(&gt;|z|)
(Intercept)     5.02 0.160 31.4 1.09e-216
chaparral      -1.07 0.316 -3.4  6.86e-04

AIC: 964.676 
Number of sites: 307
optim convergence code: 0
optim iterations: 172 
Bootstrap iterations: 0 

Survey design: point-transect
Detection function: halfnorm
UnitsIn: m
UnitsOut: ha </code></pre>
</div>
</div>
<section id="utilizando-gdistsamp" class="level2">
<h2 class="anchored" data-anchor-id="utilizando-gdistsamp">Utilizando gdistsamp</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>jay_gd_umf <span class="ot">&lt;-</span> <span class="fu">unmarkedFrameGDS</span>(<span class="at">y =</span> y,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">siteCovs =</span> covs,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">numPrimary =</span> <span class="dv">1</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">dist.breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">unitsIn =</span> <span class="st">"m"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">survey =</span> <span class="st">"point"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>jay_gd_m1 <span class="ot">&lt;-</span>  <span class="fu">gdistsamp</span>(<span class="at">lambdaformula =</span>  <span class="sc">~</span>chaparral <span class="sc">+</span> elevation, <span class="at">phiformula =</span>  <span class="sc">~</span><span class="dv">1</span>, <span class="at">pformula =</span>  <span class="sc">~</span>chaparral,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> jay_gd_umf, <span class="at">keyfun =</span> <span class="st">"halfnorm"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">output =</span> <span class="st">"abund"</span>, <span class="at">mixture =</span> <span class="st">"NB"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(jay_gd_m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
gdistsamp(lambdaformula = ~chaparral + elevation, phiformula = ~1, 
    pformula = ~chaparral, data = jay_gd_umf, keyfun = "halfnorm", 
    output = "abund", mixture = "NB")

Abundance (log-scale):
            Estimate      SE      z  P(&gt;|z|)
(Intercept) -0.24411 0.36814 -0.663 5.07e-01
chaparral    4.23251 0.76060  5.565 2.63e-08
elevation   -0.00174 0.00116 -1.502 1.33e-01

Detection (log-scale):
            Estimate    SE     z P(&gt;|z|)
(Intercept)    4.924 0.126 39.22 0.00000
chaparral     -0.872 0.251 -3.47 0.00052

Dispersion (log-scale):
 Estimate    SE     z  P(&gt;|z|)
     -1.1 0.215 -5.13 2.86e-07

AIC: 704.1823 
Number of sites: 307
optim convergence code: 0
optim iterations: 57 
Bootstrap iterations: 0 </code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(jay_gd_m1) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>numeric(0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(jay_m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>numeric(0)</code></pre>
</div>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fitstats <span class="ot">&lt;-</span> <span class="cf">function</span>(Mod_global2) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  observed <span class="ot">&lt;-</span> <span class="fu">getY</span>(Mod_global2<span class="sc">@</span>data)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">fitted</span>(Mod_global2)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  resids <span class="ot">&lt;-</span> <span class="fu">residuals</span>(Mod_global2)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  sse <span class="ot">&lt;-</span> <span class="fu">sum</span>(resids<span class="sc">^</span><span class="dv">2</span>,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  chisq <span class="ot">&lt;-</span> <span class="fu">sum</span>((observed <span class="sc">-</span> expected)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> expected,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  freeTuke <span class="ot">&lt;-</span> <span class="fu">sum</span>((<span class="fu">sqrt</span>(observed) <span class="sc">-</span> <span class="fu">sqrt</span>(expected))<span class="sc">^</span><span class="dv">2</span>,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">SSE=</span>sse, <span class="at">Chisq=</span>chisq, <span class="at">freemanTukey=</span>freeTuke)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>(pb <span class="ot">&lt;-</span> <span class="fu">parboot</span>(jay_gd_m1, fitstats, <span class="at">nsim=</span><span class="dv">100</span>, <span class="at">report=</span><span class="dv">1</span>))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>cHat_pb <span class="ot">&lt;-</span> pb<span class="sc">@</span>t0[<span class="dv">2</span>] <span class="sc">/</span> <span class="fu">mean</span>(pb<span class="sc">@</span>t.star[,<span class="dv">2</span>])</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>cHat_pb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-7-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>getN <span class="ot">&lt;-</span> <span class="cf">function</span>(fm, <span class="at">newdata=</span> <span class="cn">NULL</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">predict</span>(fm, <span class="at">type =</span> <span class="st">"lambda"</span>, <span class="at">newdata =</span> newdata)[,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getN</span>(jay_gd_m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 927.1628</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimador bayes empirico de la distribucion posterior</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>re.jay <span class="ot">&lt;-</span> <span class="fu">ranef</span>(jay_gd_m1)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">bup</span>(re.jay, <span class="st">"mean"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 826.0171</code></pre>
</div>
</div>
</div>
<div id="tabset-1-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-8-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>chaparral_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">chaparral =</span> <span class="fu">seq</span>(<span class="fu">min</span>(issj<span class="sc">$</span>chaparral, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">max</span>(issj<span class="sc">$</span>chaparral, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">length =</span> <span class="dv">100</span>),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">elevation =</span> <span class="fu">mean</span>(issj<span class="sc">$</span>elevation))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>elevation_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">elevation =</span> <span class="fu">seq</span>(<span class="fu">min</span>(issj<span class="sc">$</span>elevation, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">max</span>(issj<span class="sc">$</span>elevation, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">length =</span> <span class="dv">100</span>),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">chaparral =</span> <span class="fu">mean</span>(issj<span class="sc">$</span>chaparral))</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>chaparral_pre <span class="ot">&lt;-</span> <span class="fu">predict</span>(jay_gd_m1, <span class="at">newdata=</span> chaparral_df,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">appendData =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="st">"lambda"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>elevation_pre <span class="ot">&lt;-</span> <span class="fu">predict</span>(jay_gd_m1, <span class="at">newdata=</span> elevation_df,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">appendData =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="st">"lambda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-9-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> chaparral_pre, <span class="fu">aes</span>(<span class="at">x=</span> chaparral, <span class="at">y=</span> Predicted))<span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax=</span> upper),</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>)<span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>)<span class="sc">+</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Clase3_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> elevation_pre, <span class="fu">aes</span>(<span class="at">x=</span> elevation, <span class="at">y=</span> Predicted))<span class="sc">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax=</span> upper),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>)<span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>)<span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Clase3_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="HN%20Cursos%20publicidad/HN%20Biology%20Inv%20large.jpg" class="img-fluid figure-img"></p>
<figcaption>HN Biology Investigation Academy</figcaption>
</figure>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>