---
title: "Clase 2: Modelos N-Mixture para estimar abundancia"
author: "David Murillo"
format:
  html:
    css: styles.css
---

## Introducci칩n a los modelos de abundancia 

La abundancia, o el tama침o poblacional, se refiere al n칰mero de individuos en un lugar y tiempo determinados. Normalmente, denotamos la abundancia como *N洧녰洧노* , dondo *i* representa el lugar (espacio) y *t* es un 칤ndice para el tiempo. Sin duda, la abundancia debe ser la variable de estado m치s importante en toda la ecolog칤a. Esto se ilustra claramente por el hecho de que varios libros influyentes de ecolog칤a tienen la palabra "abundancia" en su t칤tulo (por ejemplo, Andrewartha y Birch, 1954; Krebs, 2009). 

Cuando contamos animales o plantas, estamos midiendo abundancia: un conteo *C* es una medida de la abundancia. Al medir la abundancia, existen exactamente dos tipos posibles de errores de medici칩n: (1) podemos pasar por alto o no detectar a un individuo, o (2) podemos contar a un individuo varias veces o incluir otra especie en el conteo (identificaci칩n err칩nea de la especie). El primero representa un error de falso negativo (o de detecci칩n) y conduce a un sesgo negativo en el conteo en relaci칩n con la abundancia, mientras que los dos 칰ltimos representan errores de falso positivo y conducen a un sesgo positivo en el conteo en relaci칩n con la abundancia. Estos son los tipos de errores m치s fundamentales en cualquier medici칩n de abundancia. Hay otras fuentes de errores; por ejemplo, para estudiar el tama침o de una poblaci칩n de adultos territoriales de alguna especie, pero no ser capaz de distinguir juveniles de adultos o individuos territoriales de individuos transitorios. Sin embargo, si realmente no puedes distinguirlos, en cierto sentido esto no es un error, sino simplemente que se est치 pidiendo demasiado. Necesitamos redefinir nuestro *N* para abarcar juveniles, adultos, locales y transitorios por igual. Por lo tanto, esto es un problema de c칩mo defines *N*. 

## Modelo *N-mixture* para abundancia

El modelo N-mixture  [(Royle, 2004b)](https://doi.org/10.1111/j.0006-341X.2004.00142.x) es posiblemente el modelo jer치rquico (HM) m치s representativo para estimar la abundancia animal. Similar al modelo de ocupaci칩n, el dise침o de muestreo tiene una estructura de medidas repetidas, donde se muestrean *M* sitios en *I* ocasiones (por ejemplo, conteos puntuales de aves en *I* ma침anas dentro de la misma temporada), y se registran los individuos de una especie. Las observaciones son los conteos *y*, y el modelo de observaci칩n se asume que sigue una distribuci칩n binomial, condicionada al tama침o real de la poblaci칩n en el sitio *i*:

$$y_{ij}| \sim Binomial(N_i,p)$$

Aqu칤, *p* representa la probabilidad de detecci칩n a nivel individual (en contraste con la probabilidad de detecci칩n a nivel de sitio en el modelo de ocupaci칩n). Generalmente, se pueden modelar factores que influyen en la detecci칩n utilizando modelos lineales generalizados (GLMs) con la funci칩n de enlace logit, pero por ahora se omite esta generalidad. Al igual que en el modelo de ocupaci칩n, es necesario contar con conteos repetidos (es decir, "mediciones de abundancia") en al menos algunos sitios para garantizar la identificabilidad de los par치metros del modelo. La variable de estado en este caso es el "tama침o local de la poblaci칩n", *N*, y el GLM de Poisson es el marco natural para modelar la variaci칩n en esta variable de estado:

$$N_i \sim Poisson(\lambda_i)$$

En casi todos los estudios, existe inter칠s en modelar el efecto de covariables medibles, por lo que se consideran modelos para el logaritmo de *풭* (es decir, el enlace can칩nico para GLMs de Poisson):

$$log(\lambda) = \beta_0 + \beta_1x_i$$

donde *x* es alguna covariable a nivel de sitio. Por supuesto, tambi칠n se pueden considerar modelos alternativos para la abundancia local, como el Poisson inflado con ceros, el Poisson lognormal o el binomial negativo, que consideran la variaci칩n excesiva (o sobredispersi칩n) en la abundancia local en comparaci칩n con el modelo de Poisson.

Al igual que el modelo de ocupaci칩n, el modelo N-mixture es un tipo de GLM compuesto: tanto el modelo de observaci칩n como el de proceso son GLMs est치ndar, pero est치n vinculados mediante la estructura de dependencia condicional del modelo jer치rquico. Los modelos N-mixture se implementan en el programa PRESENCE (Hines, 2006), en el programa MARK (White y Burnham, 1999), y en el paquete unmarked de R mediante la funci칩n pcount.

## **EL Paquete de R `unmarked`**

El paquete de R unmarked ([Fiske y Chandler, 2011](https://doi.org/10.18637/jss.v043.i10)) proporciona una plataforma integral para el an치lisis de muchos de los modelos jer치rquicos (HMs) que cubrimos en este curso. Implementa estimaciones basadas en verosimilitud marginal y ofrece funciones de soporte para la organizaci칩n de datos, res칰menes y an치lisis gr치ficos. El paquete fue desarrollado originalmente por Ian Fiske como estudiante de posgrado en la Universidad Estatal de Carolina del Norte, y fue asumido en gran medida por Richard Chandler alrededor del a침o 2011.

El paquete unmarked ofrece un marco unificado para la manipulaci칩n de datos, exploraci칩n de datos, ajuste de modelos (mediante m치xima verosimilitud), selecci칩n de modelos, promediado de modelos, evaluaci칩n del ajuste del modelo (Gof, por sus siglas en ingl칠s), predicci칩n, e implementa ideas como bootstrapping, predicci칩n, estimaci칩n emp칤rica Bayesiana y otros procedimientos de inferencia y an치lisis. Los modelos jer치rquicos principales disponibles en unmarked son los siguientes:

- Modelo de ocupaci칩n por sitios de una sola temporada ("est치tico") (MacKenzie et al., 2002; Tyre et al., 2003)

- Modelo est치tico de Royle-Nichols (Royle y Nichols, 2003)

- Modelo est치tico de ocupaci칩n con falsos positivos (Royle y Link, 2006; Miller et al., 2011)

- Modelos est치ticos de ocupaci칩n penalizada (Hutchinson et al., 2015)

- Modelo est치tico binomial de mezcla N (Royle, 2004b)

- Modelo est치tico multinomial de mezcla N (Royle, 2004a; Dorazio et al., 2005; Langtimm et al., 2011)

- Modelo jer치rquico est치tico de muestreo por distancias (Royle et al., 2004)

- Versiones de "poblaci칩n abierta" para muchos de los anteriores: 1) Modelo din치mico de ocupaci칩n (MacKenzie et al., 2003), 2) Modelo de mezcla multinomial con emigraci칩n temporal (Chandler et al., 2011), 3) Muestreo por distancias con emigraci칩n temporal, modelo din치mico de *N*-Mixture (Dail y Madsen, 2011), muestreo por distancias din치mico (Sollmann et al., 2015).

Con frecuencia, los modeladores jer치rquicos en formaci칩n tienen dificultades para determinar qu칠 tipo de modelo deber칤an utilizar para abordar un problema espec칤fico. Una clave dicot칩mica simple puede ayudar a guiar al usuario hacia la funcionalidad adecuada de unmarked (Figura 2.1).

![](booksPictures/Screenshot 2024-11-19 071853.png)
Figura 2.1 츼rbol de decisi칩n para los modelos disponibles en el paquete de R unmarked. Una pregunta cient칤fica o de manejo (el signo de interrogaci칩n en el cuadro superior) sugiere primero un enfoque en abundancia u ocurrencia; en segundo lugar, si el sistema es est치tico o din치mico; y en tercer lugar, el m칠todo de muestreo utilizado. Todos estos factores determinan el modelo apropiado para su estudio.

## Ejercicio 

Voluntarios experimentados realizan un recorrido transecto irregular, espec칤fico para cada cuadrante, cuya longitud var칤a entre 1 y 9 km. Cada transecto se recorre tres veces durante la temporada de cr칤a (de mediados de abril a principios de julio) utilizando el m칠todo de mapeo de territorios (Bibby et al., 2000). Los cuadrantes situados en 치reas altas (por encima de la l칤nea de 치rboles) se inspeccionan solo dos veces. Los recorridos comienzan al amanecer y duran en promedio cuatro horas (SD = 1 h). Los observadores registran en un mapa la ubicaci칩n de cada individuo de cada especie identificada. Posteriormente, los territorios provisionales se determinan en funci칩n de la agrupaci칩n de observaciones y, para los registros aislados, en funci칩n del conocimiento de los tama침os t칤picos de los territorios de cada especie.

Aqu칤 analizaremos los conteos por cuadrante del n칰mero de territorios de carbonero com칰n (*y*) en el cuadrante *i* durante el recorrido *j* en 2013. El conjunto de datos incluye coordenadas del sitio y covariables como elevaci칩n (m), cobertura forestal (%), y longitud de la ruta (km), as칤 como covariables observacionales como la fecha (d칤a 1 = 1 de abril) y la duraci칩n (min) de cada recorrido.

Los objetivos de nuestro an치lisis son dos:

- Identificar los factores ambientales que afectan la abundancia de carboneros comunes en Suiza.

- Estimar el tama침o de la poblaci칩n de carboneros comunes en Suiza en 2013.

::: panel-tabset

### Cargar base de datos


```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(unmarked)
library(AICcmodavg)
library(MuMIn)
```


```{r}
Tits <- read.csv("data/Tits.csv")

str(Tits)
```

Seleccionar variables necesarias

```{r}

Tits <- Tits %>% 
  select(X1, X2, X3,
         elev, forest,
         time.1, time.2, time.3,
         date.1, date.2, date.3,
         dur.1, dur.2, dur.3)

head(Tits)
```

### Formatear base de datos a formato unmarked


```{r}

y <- Tits[,c("X1", "X2", "X3")]

SiteVar <- Tits[,c("elev", "forest")]

ObsVar <- list(Time = Tits[,c("time.1", "time.2", "time.3")],
               Date = Tits[,c("date.1", "date.2", "date.3")],
               Dur = Tits[,c("dur.1", "dur.2", "dur.3")])

```

```{r}

Tits_umf <- unmarkedFramePCount(y = y, siteCovs = SiteVar, 
                                    obsCovs= ObsVar )

summary(Tits_umf)

```

### Ajustar modelo de deteccion

```{r, warning=FALSE, message=FALSE}


ModelDet0 <- pcount(~1 ~1, Tits_umf ) ##Null model

ModelDet1 <- pcount(~Date ~1, Tits_umf )

ModelDet2 <- pcount(~Time ~1, Tits_umf )

ModelDet3 <- pcount(~Dur ~1, Tits_umf )
```

## Seleccion de modelo de deteccion

```{r}

DetModels <- list(ModelDet0, ModelDet1, ModelDet2, ModelDet3)

DetNames <- c("Nulo", "Fecha", "Hora", "Dur")

aictab(DetModels, DetNames, sort = TRUE)
```

### Ajustar modelo de Abundancia

```{r, warning=FALSE, message=FALSE}

ModelAbun0 <- pcount(~Date ~ 1, Tits_umf) 

ModelAbun1 <- pcount(~Date ~ elev, Tits_umf)

ModelAbun2 <- pcount(~Date ~ forest, Tits_umf)

ModelAbun3 <- pcount(~Date ~ elev + forest, Tits_umf)
```

### Seleccion de modelo de abundancia

```{r}
AbunModels <- list(ModelAbun0, ModelAbun1, ModelAbun2, ModelAbun3)

AbunNames <- c("Nulo", "elev", "forest", "elev + forest")

aictab(AbunModels, AbunNames, sort = TRUE)
```

### Resumen de los resultados

```{r}
summary(ModelAbun3)
confint(ModelAbun3, type = "state", level = 0.95)
```

### Bondad de ajuste

```{r, warning=FALSE, message=FALSE}


fitstats <- function(Mod_global2) {
  observed <- getY(Mod_global2@data)
  expected <- fitted(Mod_global2)
  resids <- residuals(Mod_global2)
  sse <- sum(resids^2,na.rm=TRUE)
  chisq <- sum((observed - expected)^2 / expected,na.rm=TRUE)
  freeTuke <- sum((sqrt(observed) - sqrt(expected))^2,na.rm=TRUE)
  out <- c(SSE=sse, Chisq=chisq, freemanTukey=freeTuke)
  return(out)
}

(pb <- parboot(ModelAbun3, fitstats, nsim=100, report=1))

cHat_pb <- pb@t0[2] / mean(pb@t.star[,2])


MigGOF <- Nmix.gof.test(ModelAbun3, nsim = 100, report = 3)


```

### Prepar data para graficar

```{r}
Elev <- data.frame(elev = seq(min(Tits$elev, na.rm = TRUE), max(Tits$elev, na.rm = TRUE), length.out = 100),
                   forest = mean(Tits$forest, na.rm = TRUE))

Forest <- data.frame(forest = seq(min(Tits$forest, na.rm = TRUE), max(Tits$forest, na.rm = TRUE), length.out = 100),
                   elev = mean(Tits$elev, na.rm = TRUE))
                                 
```

```{r}
Elev_pre <- predict(ModelAbun3, newdata= Elev, appendData = TRUE, type = "state")

Forest_pre <- predict(ModelAbun3, newdata= Forest, appendData = TRUE, type = "state")
```


### Graficar modelo

```{r}
ggplot(data= Elev_pre, aes(x= elev, y= Predicted))+
  geom_ribbon(aes(ymin= lower,
                  ymax= upper), fill = "lightblue") +
  geom_line(color= "black") +
  labs(x = "Elevacion", 
       y = "Abundancia")+
  ggtitle("Abundancia explicada por la elevacion") +
  theme_classic()
```



```{r}
ggplot(data= Forest_pre, aes(x= forest, y= Predicted))+
  geom_ribbon(aes(ymin= lower,
                  ymax= upper), fill = "lightblue") +
  geom_line(color= "black") +
  labs(x = "% Bosque", 
       y = "Abundancia")+
  ggtitle("Abundancia explicada por el % bosque") +
  theme_classic()
```


:::

![HN Biology Investigation Academy](HN Cursos publicidad/HN Biology Inv large.jpg)
