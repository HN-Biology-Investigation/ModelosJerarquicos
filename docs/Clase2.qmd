---
title: "Clase 2: Modelos N-Mixture para estimar abundancia"
author: "David Murillo"
format:
  html:
    css: styles.css
---

## **EL Paquete de R `unmarked`**

El paquete de R unmarked ([Fiske y Chandler, 2011](https://doi.org/10.18637/jss.v043.i10)) proporciona una plataforma integral para el análisis de muchos de los modelos jerárquicos (HMs) que cubrimos en este curso. Implementa estimaciones basadas en verosimilitud marginal y ofrece funciones de soporte para la organización de datos, resúmenes y análisis gráficos. El paquete fue desarrollado originalmente por Ian Fiske como estudiante de posgrado en la Universidad Estatal de Carolina del Norte, y fue asumido en gran medida por Richard Chandler alrededor del año 2011.

El paquete unmarked ofrece un marco unificado para la manipulación de datos, exploración de datos, ajuste de modelos (mediante máxima verosimilitud), selección de modelos, promediado de modelos, evaluación del ajuste del modelo (Gof, por sus siglas en inglés), predicción, e implementa ideas como bootstrapping, predicción, estimación empírica Bayesiana y otros procedimientos de inferencia y análisis. Los modelos jerárquicos principales disponibles en unmarked son los siguientes:

- Modelo de ocupación por sitios de una sola temporada ("estático") (MacKenzie et al., 2002; Tyre et al., 2003)

- Modelo estático de Royle-Nichols (Royle y Nichols, 2003)

- Modelo estático de ocupación con falsos positivos (Royle y Link, 2006; Miller et al., 2011)

- Modelos estáticos de ocupación penalizada (Hutchinson et al., 2015)

- Modelo estático binomial de mezcla N (Royle, 2004b)

- Modelo estático multinomial de mezcla N (Royle, 2004a; Dorazio et al., 2005; Langtimm et al., 2011)

- Modelo jerárquico estático de muestreo por distancias (Royle et al., 2004)

- Versiones de "población abierta" para muchos de los anteriores: 1) Modelo dinámico de ocupación (MacKenzie et al., 2003), 2) Modelo de mezcla multinomial con emigración temporal (Chandler et al., 2011), 3) Muestreo por distancias con emigración temporal, modelo dinámico de *N*-Mixture (Dail y Madsen, 2011), muestreo por distancias dinámico (Sollmann et al., 2015).

Con frecuencia, los modeladores jerárquicos en formación tienen dificultades para determinar qué tipo de modelo deberían utilizar para abordar un problema específico. Una clave dicotómica simple puede ayudar a guiar al usuario hacia la funcionalidad adecuada de unmarked (Figura 2.1).



::: panel-tabset
## Cargar base de datos

```{r}
Aves <- read.csv("data/AvesHabitatUm.csv")
```

Seleccionar variables necesarias

```{r}

library(tidyverse)

AvesLimpia <- Aves %>% 
  select(Site, VEGID, Type, ALTITUDE, Area_Basal, Hora, Fecha, Cielo, Viento, Especies, Abundancia) %>% 
  mutate(Fecha = as.Date(Fecha, format = "%m/%d/%Y")) %>% 
  mutate(Hora = as.integer(str_replace(Hora, ":", "")))
  
AvesOrdenadas <- AvesLimpia %>%
  arrange(Site, Especies, Fecha, Hora, VEGID, Type, ALTITUDE, Area_Basal) %>%
  group_by(Site, Especies, Fecha, Hora, VEGID, Type, ALTITUDE, Area_Basal) %>%
  summarise(Abundancia = max(Abundancia)) %>%
  group_by(Site, Fecha, Hora,  Especies, VEGID, Type, ALTITUDE, Area_Basal) %>%
  mutate(Orden = factor(row_number())) %>% 
  filter(Orden %in% c(1, 2, 3))

CarpusPivot <- AvesOrdenadas %>% 
  pivot_wider(names_from = Especies, values_from = Abundancia, values_fill = 0) %>% 
  select(Site, VEGID, Type, ALTITUDE, Area_Basal, Fecha, Hora, Orden, CARPUS)

CarpusPivotOrden <- CarpusPivot %>%
  arrange(Site, VEGID, Type, ALTITUDE, Area_Basal, CARPUS, Fecha, Hora) %>%
  group_by(Site,VEGID, Type, ALTITUDE, Area_Basal, CARPUS) %>%
  mutate(Orden = factor(row_number())) %>% 
  filter(!is.na(Site))
  

head(CarpusPivotOrden)
```

## Formatear base de datos a formato unmarked

Pasar cada replica en columnas diferentes de acuerdo a la especie de ave

```{r}


# Crear un conjunto de datos con todos los niveles de Orden por Site
CARPUSunmarked <- CarpusPivotOrden %>%
  filter(!is.na(Fecha)) %>% 
  mutate(Orden = as.numeric(Orden)) %>% 
  complete(Orden = 1:3) %>%
  mutate(CARPUS = ifelse(is.na(Fecha), NA, CARPUS),
         CARPUS = replace_na(CARPUS, 50))

# Pivot_wider
CARPUSunmarkedReady <- CARPUSunmarked %>%
  mutate(Fechaord = yday(Fecha)) %>% 
  group_by(Site, Orden, VEGID, Type, ALTITUDE, Area_Basal) %>%
  summarise(CARPUS = max(CARPUS),
            Fechaord = max(Fechaord),
            Hora = max(Hora)) %>% 
  ungroup() %>%
  group_by(Site, VEGID, Type, ALTITUDE, Area_Basal) %>% 
  pivot_wider(names_from = Orden,
              values_from = c(Fechaord, Hora, CARPUS),
              values_fill =  0) %>% 
  mutate(CARPUS_1 = replace(CARPUS_1, CARPUS_1 == 50, NA)) %>% 
  mutate(CARPUS_2 = replace(CARPUS_2, CARPUS_2 == 50, NA)) %>% 
  mutate(CARPUS_3 = replace(CARPUS_3, CARPUS_3 == 50, NA)) 


```

## Crear variables de detectabilidad

```{r}
## Definir ocasiones de deteccion
CARPUS_y <- CARPUSunmarkedReady[,12:14]
# y[y > 1] <- 1


## Definir los variables asociados a la deteccion:


Fecha_CARPUS= list(Fecha=CARPUSunmarkedReady[,6:8]) 

# Y quien realizo la observacion

Hora_CARPUS= list(Hora=CARPUSunmarkedReady[,9:11]) 


```

## Crear variables de habitat (covariables)

```{r}
## Definir los variables de covarianza

CARPUS_siteCovs <- CARPUSunmarkedReady[,c("Type", "ALTITUDE", "Area_Basal")]
```

## Crear tabla unmarked

```{r}

library(unmarked)

## CREAR DATA FRAME
CARPUSunmarked_df <- unmarkedFramePCount(y = CARPUS_y, siteCovs = CARPUS_siteCovs, 
                                    obsCovs=c(Fecha_CARPUS, Hora_CARPUS))

summary(CARPUSunmarked_df)

```

## Ajustar modelo de deteccion

```{r}
#### MODELAR DETECCION PRIMERO

ModelDet0 <- pcount(~1 ~1, CARPUSunmarked_df) ##Null model

ModelDet1 <- pcount(~Fecha ~1, CARPUSunmarked_df)

ModelDet2 <- pcount(~Hora ~1, CARPUSunmarked_df)

ModelDet3 <- pcount(~Fecha + Hora ~1, CARPUSunmarked_df)
```

## Seleccion de modelo de deteccion

```{r}
library(AICcmodavg)

DetModels <- list(ModelDet0, ModelDet1, ModelDet2, ModelDet3)

DetNames <- c("Nulo", "Fecha", "Hora", "Fecha + Hora")

aictab(DetModels, DetNames, sort = TRUE)
```

## Ajustar modelo de Abundancia

```{r}
#### MODELAR DETECCION PRIMERO

ModelAbun0 <- pcount(~1 ~ 1, CARPUSunmarked_df) ##Null model

ModelAbun1 <- pcount(~1 ~ Type, CARPUSunmarked_df)

ModelAbun2 <- pcount(~1 ~ ALTITUDE, CARPUSunmarked_df)

ModelAbun3 <- pcount(~1 ~ Area_Basal, CARPUSunmarked_df)
```

## Seleccion de modelo de abundancia

```{r}
library(AICcmodavg)

AbunModels <- list(ModelAbun0, ModelAbun1, ModelAbun2, ModelAbun3)

AbunNames <- c("Nulo", "Type", "ALTITUDE", "Area_Basal")

aictab(AbunModels, AbunNames, sort = TRUE)
```

## Resumen de los resultados

```{r}
summary(ModelAbun3)
confint(ModelAbun3, type = "state", level = 0.9)
```

## Bondad de ajuste

```{r, warning=FALSE, message=FALSE}


fitstats <- function(Mod_global2) {
  observed <- getY(Mod_global2@data)
  expected <- fitted(Mod_global2)
  resids <- residuals(Mod_global2)
  sse <- sum(resids^2,na.rm=TRUE)
  chisq <- sum((observed - expected)^2 / expected,na.rm=TRUE)
  freeTuke <- sum((sqrt(observed) - sqrt(expected))^2,na.rm=TRUE)
  out <- c(SSE=sse, Chisq=chisq, freemanTukey=freeTuke)
  return(out)
}

(pb <- parboot(ModelAbun3, fitstats, nsim=100, report=1))

cHat_pb <- pb@t0[2] / mean(pb@t.star[,2])


MigGOF <- Nmix.gof.test(ModelAbun3, nsim = 100, report = 3)


```

## Prepar data para graficar

```{r}
CARPUS_arear_basal <- data.frame(Area_Basal = seq(min(CARPUSunmarkedReady$Area_Basal, na.rm = TRUE), max(CARPUSunmarkedReady$Area_Basal, na.rm = TRUE), length.out = 100))
                                 
Carpus_pre_area_basal <- predict(ModelAbun3, newdata = CARPUS_arear_basal, type = "state")

Carpus_pre_area_basal$Area_Basal <- CARPUS_arear_basal$Area_Basal 
```

## Graficar modelo

```{r}
ggplot(data= Carpus_pre_area_basal, aes(x= Area_Basal, y= Predicted))+
  geom_ribbon(aes(ymin= lower,
                  ymax= upper), fill = "lightblue") +
  geom_line(color= "black") +
  labs(x = "Area Basal", 
       y = "Abundancia")+
  ggtitle("Relacion de Cardenilla pusilla versus el area basal") +
  theme_classic()
```
:::

![HN Biology Investigation Academy](HN%20Cursos%20publicidad/HN%20Biology%20Inv%20large.jpg)
